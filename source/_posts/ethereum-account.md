---
title: 以太坊（一）：以太坊的账户体系和主要数据结构
date: 2023-03-08 00:15:51
published: false
tags:
categories:
- Blockchain
---

以太坊是区块链的升级版，有人把原来中本聪的区块链叫 blockchain1.0，而以太坊则叫 blockchain2.0，因此，学习以太坊会以对比区块链的方式学习，看看以太坊相较于区块链做了什么改进，有什么不同的理念。

<!--more-->

本节主要是讲以太坊的账户体系和主要数据结构，其核心主要是三个关键的数据结构：

1、状态树，用于存放全量账户数据；

2、交易树，即我们讲过的 merkle tree；

3、收据树，它和交易树的信息节点一一对应，即一笔交易对应一笔收据，主要用于弥补 merkle tree 难于查找的缺点。



## 状态树

和区块链不同，区块链是全节点维护一个 UTXO （即unspending transaction output，未使用输出）来保证交易的合法和正确性的。但这么做有个缺点，即每一次交易，转账方都必须讲自己的钱都花出去，例如 A 有 10 个比特币给，想给 B 3 个比特币，那么交易的输入输出就是，A 输出 10 个比特币，另一边 B 输入 3 个比特币，A 输入 7 个比特币。区块链经过大量交易后，全节点需要对所有的输出输入计算，得出最终的输出结果，这样才能维护交易的合法，安全和正确。

简单来说，区块链没有账户状态的概念，也就是没有余额的概念，而以太坊则引入这个概念，每一个全节点的每一个区块都会维护一个状态树，每次交易，都会通过这个状态树上的账户状态来检查交易。



### 状态信息

那么状态信息需要保存什么字段呢？至少需要保存余额，即这个账户的余额。但实际上保存余额是不够的，看这个场景：

假设 A 有 100 个以太币，A 给 B 转了 10 个以太币，这个转账操作有 A 的私钥签名，以及 B 的地址，交易顺利完成，然后 B 重放这个交易请求，由于 A 的余额是足够的， 因此相当于 A 又给 B 转了 10 个以太币，因此 B 获利了。这和区块链不同，区块链重放请求是不会有这个效果的，因为区块链是依赖 UTXO，全节点已经接受了前一个交易，即前一个节点 A 的输出是 100 个比特币，交易完成后，A 输入是 90 个比特币，若 B 重放这个请求，那么只能重放 A 的输出是 100 个比特币的请求，但通过 UTXO 计算出 A 的余额是 90 个比特币，这样交易校验是不会通过的。

以太坊由于有了状态的概念，不会再去维护 UTXO，因此交易的时候 A 的输出是 10 个以太币，A 余额扣减 10 个以太币，B 是可以重放这个请求的。为了防止 B 重放，以太坊交易的时候除了填写交易金额，还需要填写一个 nonce 字段，表示这是 A 的第几次交易。这个字段放在状态信息中维护，每次交易时 nonce 值加 1，下一次交易的时候会对比交易信息和账户信息的 nonce 值是否一致，因此，B 若重放 A 的请求，由于交易信息有 A 的私钥签名，无法串改 nonce，导致交易信息和状态信息不一致，交易无法校验通过，从而防止了 B 的恶意重放。

注意：此 nonce 和挖矿的 nonce 无任何关系。

![防止恶意节点重放](https://www.jackhuang.cc/svg/ethreplay-message.svg)



### 状态树的数据结构

#### trie

在讲真正的状态树之前，先稍微了解一下 trie 数据结构，它主要用于解决“查字典”问题，比如一本英文小说有很多英文单词，那么如果给出一个单词，如何快速返回这个单词在这本英文小说出现的位置？方法当然有很多，最熟悉的是使用哈希，而 trie 树则使用了另一个方法，即 trie 是这么一个数据机构，每一个节点都有 26 个出口，每个出口表示某个单词的下一个字母，出口另一端则是下一个字母节点，从根节点出发，按照单词的字母进行寻路，直到单词所有字母被消耗完，那么所在节点就是这个单词的信息，存放有单词的位置信息。

例如，general，genesis，go，god和good这几个单词，其 trie 树看起来是这样：

![trie树](https://www.jackhuang.cc/svg/trie.svg)

上图中从 root 节点出发，按照单词的字母寻路，走到紫色节点既是单词的信息节点。



#### patricia tree

trie 结构有一个致命缺陷就是从根节点到信息节点中间浪费了很多无效节点，很占空间和遍历的时间，因此，patricia tree 则优化了这一点，把中间的白色节点折叠起来：

![patricia tree](https://www.jackhuang.cc/svg/patricia-tree.svg)

### 以太坊账户结构 MPT

以太坊状态是存放在 patricia tree 中的，同时会建立一个 merkle patricia tree，简称 MPT，以防止信息被修改：









## 交易树



## 收据树
